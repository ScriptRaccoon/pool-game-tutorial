(()=>{function S(i,t){return{x:i.x+t.x,y:i.y+t.y}}function u(i,t){return{x:i.x-t.x,y:i.y-t.y}}function v(i,t){return{x:i*t.x,y:i*t.y}}function y(i){return Math.sqrt(Math.pow(i.x,2)+Math.pow(i.y,2))}function E(i,t){return Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2))}function U(i){return i.x==0&&i.y==0?i:v(1/y(i),i)}function G(i,t){let r=y(t);return r<=i?t:v(i/r,t)}function I(i,t){return i.x*t.x+i.y*t.y}function A(i,t){return Math.acos(I(i,t)/(y(i)*y(t)))}function D(i,t){return{x:t.x*Math.cos(i)-t.y*Math.sin(i),y:t.x*Math.sin(i)+t.y*Math.cos(i)}}function J(i,t,r){let n=t*t-4*i*r;if(n<0)return[];let l=Math.sqrt(n);return[(-t+l)/(2*i),(-t-l)/(2*i)]}function H(i,t){let[r,n]=i,[l,w]=t,g=Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2),P=2*((r.x-l.x)*(n.x-r.x)+(r.y-l.y)*(n.y-r.y)),b=Math.pow(r.x-l.x,2)+Math.pow(r.y-l.y,2)-Math.pow(w,2),C=J(g,P,b);return C.length>0&&C.some(N=>N>=0&&N<=1)}var o=document.getElementById("canvas"),h=o.getContext("2d"),T=document.getElementById("tableCanvas"),s=T.getContext("2d"),e=60;o.width=T.width=1200+2*e;o.height=T.height=600+2*e;function Y(){h.clearRect(0,0,o.width,o.height)}var K=y({x:o.width,y:o.height});var L=document.getElementById("dialog"),V=document.getElementById("dialogContent"),Z=document.getElementById("closeBtn");function B(i){V.innerHTML=i,L.open=!0}function W(){L.classList.add("close"),setTimeout(()=>{L.classList.remove("close"),L.open=!1,V.innerHTML=""},300)}Z.addEventListener("click",W);var M={x:0,y:0};window.addEventListener("mousemove",i=>{let t=o.getBoundingClientRect();M.x=(i.clientX-t.left)*(o.width/t.width),M.y=(i.clientY-t.top)*(o.height/t.height)});var p={CUE:new Audio("./sfx/cue.mp3"),COLLISION:new Audio("./sfx/collision.mp3"),BUMPER:new Audio("./sfx/bumper.mp3"),POCKET:new Audio("./sfx/pocket.mp3"),WHIP:new Audio("./sfx/whip.mp3"),WIN:new Audio("./sfx/win.mp3"),LOSE:new Audio("./sfx/lose.mp3")};p.WHIP.volume=.3;var R=class{constructor(t){this.ball=t,this.vector={x:0,y:0},this.addControl(),this.active=!0,this.maxLength=300}addControl(){document.addEventListener("click",t=>{if(t.target.nodeName=="BUTTON"||!this.active)return;this.active=!1;let r=.15;this.ball.vel=v(r,this.vector);let n=y(this.ball.vel),l=Math.min(1,n/(r*this.maxLength));p.CUE.volume=l,p.CUE.play()})}update(){this.vector=G(this.maxLength,u(M,this.ball.pos))}draw(){if(!this.active)return;h.save(),h.lineWidth=10,h.lineCap="round",h.strokeStyle="rgba(255,255,255,0.5)",h.translate(this.ball.pos.x,this.ball.pos.y),h.beginPath(),h.moveTo(0,0),h.lineTo(this.vector.x,this.vector.y),h.stroke(),h.closePath(),h.lineWidth=1,h.beginPath(),h.moveTo(0,0);let t=v(K,U(this.vector));h.lineTo(t.x,t.y),h.stroke(),h.closePath(),h.restore()}};var c=class{constructor({pos:t,color:r,vel:n}){this.pos=t,this.originalPos={...this.pos},this.color=r,this.vel=n??{x:0,y:0},this.originalVel={...this.vel},this.size=18,this.friction=.99,this.inPocket=!1,this.gradient=h.createRadialGradient(-.4*this.size,-.4*this.size,1,0,0,this.size),this.gradient.addColorStop(0,"rgba(255,255,255,0.25)"),this.gradient.addColorStop(.4,"rgba(255,255,255,0)"),this.gradient.addColorStop(.7,"rgba(0,0,0,0)"),this.gradient.addColorStop(1,"rgba(0,0,0,0.3)"),this.alpha=1}get idle(){return this.vel.x==0&&this.vel.y==0}draw(){if(this.alpha==0)return;this.inPocket&&(this.alpha=Math.max(0,this.alpha-.2));let t={x:(this.pos.x-o.width/2)/o.width*.5,y:.15};h.save(),h.globalAlpha=this.alpha,h.translate(this.pos.x,this.pos.y),h.beginPath(),h.arc(t.x*this.size,t.y*this.size,this.size,0,2*Math.PI),h.fillStyle="rgba(0,0,0,0.15)",h.fill(),h.closePath(),h.beginPath(),h.arc(0,0,this.size,0,2*Math.PI),h.fillStyle=this.color,h.fill(),h.fillStyle=this.gradient,h.fill(),h.closePath(),h.restore()}update(t){this.pos.x+=this.vel.x,this.pos.y+=this.vel.y,this.vel.x*=this.friction,this.vel.y*=this.friction,this.handleTinyVelocities(),!this.inPocket&&(this.bounceOffWalls(),this.bounceOffBumpers(t.bumpers),this.checkPockets(t.pockets),this.collideWithBalls(t.balls))}bounceOffWalls(){this.pos.x+this.size>=o.width-e?(this.pos.x=o.width-e-this.size,this.vel.x*=-1):this.pos.x-this.size<=e&&(this.pos.x=this.size+e,this.vel.x*=-1),this.pos.y+this.size>=o.height-e?(this.pos.y=o.height-e-this.size,this.vel.y*=-1):this.pos.y-this.size<=e&&(this.pos.y=this.size+e,this.vel.y*=-1)}handleTinyVelocities(){Math.abs(this.vel.x)<.04&&(this.vel.x=0),Math.abs(this.vel.y)<.04&&(this.vel.y=0)}collideWithBalls(t){t.forEach(r=>{if(this==r||r.inPocket)return;let n=E(this.pos,r.pos);if(n>this.size+r.size)return;let l=this.size+r.size-n,w=u(r.pos,this.pos),g=v(l/(2*n),w);this.pos=u(this.pos,g),r.pos=S(r.pos,g);let P=u(this.vel,r.vel),b=v(1/Math.pow(n,2)*I(w,P),w);this.vel=u(this.vel,b),r.vel=S(r.vel,b);let C=Math.min(1,(y(this.vel)+y(r.vel))/15);p.COLLISION.volume=C,p.COLLISION.play()})}checkPockets(t){t.forEach(r=>{if(r.includes(this)){this.inPocket=!0,p.POCKET.play();return}})}reset(t){this.inPocket=!1,this.alpha=1,this.pos={...this.originalPos},this.vel={...this.originalVel},this==t.whiteBall&&this.avoidOtherBalls(t.balls)}intersects(t){return E(this.pos,t.pos)<=this.size+t.size}avoidOtherBalls(t){for(;t.some(n=>n!=this&&this.intersects(n));){let n=Math.random()<.5?"x":"y",l=Math.random()<.5?1:-1;this.pos[n]+=4*l}}bounceOffBumpers(t){t.forEach(r=>{let n=r.intersectionSegment(this);if(n!=null){let[l,w]=n,g=u(w,l),P=A(this.vel,g);this.vel=D(2*P,this.vel);let b=Math.min(1,y(this.vel)/30);p.BUMPER.volume=b,p.BUMPER.play()}})}};var d={WHITE:"rgb(210,210,211)",BLACK:"rgba(0,0,0)",YELLOW:"rgb(255,215,0)",ORANGE:"rgb(255, 120, 0)",RED:"rgb(230,10,10)",PURPLE:"rgb(90,0,170)",BLUE:"rgb(0,80,255)",BROWN:"rgb(150,20,0)",GREEN:"rgb(0,90,0)"};function q(){let i={x:o.width-e-.25*(o.width-2*e),y:o.height/2},t={x:33,y:19};return[new c({pos:{x:e+1/4*(o.width-2*e),y:i.y},color:d.WHITE}),new c({pos:{x:i.x,y:i.y},color:d.YELLOW}),new c({pos:{x:i.x+t.x,y:i.y-t.y},color:d.BLUE}),new c({pos:{x:i.x+t.x,y:i.y+t.y},color:d.RED}),new c({pos:{x:i.x+2*t.x,y:i.y-2*t.y},color:d.PURPLE}),new c({pos:{x:i.x+2*t.x,y:i.y},color:d.ORANGE}),new c({pos:{x:i.x+2*t.x,y:i.y+2*t.y},color:d.GREEN}),new c({pos:{x:i.x+3*t.x,y:i.y-3*t.y},color:d.BROWN}),new c({pos:{x:i.x+3*t.x,y:i.y-1*t.y},color:d.BLACK}),new c({pos:{x:i.x+3*t.x,y:i.y+1*t.y},color:d.YELLOW}),new c({pos:{x:i.x+3*t.x,y:i.y+3*t.y},color:d.BLUE}),new c({pos:{x:i.x+4*t.x,y:i.y-4*t.y},color:d.RED}),new c({pos:{x:i.x+4*t.x,y:i.y-2*t.y},color:d.PURPLE}),new c({pos:{x:i.x+4*t.x,y:i.y},color:d.ORANGE}),new c({pos:{x:i.x+4*t.x,y:i.y+2*t.y},color:d.GREEN}),new c({pos:{x:i.x+4*t.x,y:i.y+4*t.y},color:d.BROWN})]}function F(){s.fillStyle="rgb(26,130,30)",s.fillRect(0,0,o.width,o.height)}function _(){let i;function t(){i.addColorStop(0,"hsl(16, 76%, 15%)"),i.addColorStop(1,"hsl(16, 76%, 30%)"),s.fillStyle=i}i=s.createRadialGradient(e,e,e,e,e,0),t(),s.fillRect(0,0,e,e),i=s.createRadialGradient(o.width-e,e,e,o.width-e,e,0),t(),s.fillRect(o.width-e,0,e,e),i=s.createRadialGradient(e,o.height-e,e,e,o.height-e,0),t(),s.fillRect(0,o.height-e,e,e),i=s.createRadialGradient(o.width-e,o.height-e,e,o.width-e,o.height-e,0),t(),s.fillRect(o.width-e,o.height-e,e,e),i=s.createLinearGradient(0,0,0,e),t(),s.fillRect(e,0,o.width-2*e,e),i=s.createLinearGradient(0,o.height,0,o.height-e),t(),s.fillRect(e,o.height-e,o.width-2*e,e),i=s.createLinearGradient(0,0,e,0),t(),s.fillRect(0,e,e,o.height-2*e),i=s.createLinearGradient(o.width,0,o.width-e,0),t(),s.fillRect(o.width-e,e,o.width,o.height-2*e)}var k=class{constructor({balls:t,pockets:r,bumpers:n}){this.balls=t,this.pockets=r,this.bumpers=n,this.won=null,this.playing=!0,this.idle=!0,this.whiteBall=this.balls.find(l=>l.color==d.WHITE),this.blackBall=this.balls.find(l=>l.color==d.BLACK),this.controller=new R(this.whiteBall),this.enableRestart()}enableRestart(){document.getElementById("restartBtn").addEventListener("click",()=>{this.restart()})}draw(){this.balls.forEach(t=>t.draw()),this.controller.draw()}drawTable(){F(),_(),this.pockets.forEach(t=>t.draw()),this.bumpers.forEach(t=>t.draw()),this.pockets.forEach(t=>t.drawMounting())}update(){!this.playing||(this.balls.forEach(t=>t.update(this)),this.idle=this.balls.every(t=>t.idle||t.inPocket),this.idle&&(this.controller.active=!0,this.controller.update(),this.blackBall.inPocket?this.finish():this.whiteBall.inPocket&&(p.WHIP.play(),this.whiteBall.reset(this))))}finish(){this.playing=!1,this.controller.active=!1,this.won=!this.whiteBall.inPocket&&this.balls.every(t=>t==this.whiteBall||t.inPocket),this.won?(p.WIN.play(),B("You won!")):(p.LOSE.play(),B("You lost!"))}restart(){p.WHIP.play(),W(),this.balls.forEach(t=>t.reset(this)),this.won=null,this.idle=!0,this.playing=!0}};var z=class{constructor({coords:t}){this.coords=t,this.color="purple"}draw(){s.fillStyle=this.color,s.beginPath(),s.moveTo(this.coords[0].x,this.coords[0].y);for(let t=1;t<this.coords.length;t++)s.lineTo(this.coords[t].x,this.coords[t].y);s.fill(),s.closePath()}intersectionSegment(t){for(let r=0;r<this.coords.length-1;r++){let n=this.coords[r],l=this.coords[r+1],w=t.pos,g=t.size;if(H([n,l],[w,g]))return[n,l]}return null}};var f=class extends z{constructor({coords:t,shadow:r}){super({coords:t}),this.color="rgb(0,90,15)",this.shadow=r||{x:0,y:0},this.shadowColor="rgba(0,0,0,0.45)"}draw(){s.filter="blur(3px)",s.beginPath(),s.moveTo(this.coords[0].x+this.shadow.x,this.coords[0].y+this.shadow.y);for(let t=1;t<this.coords.length;t++)s.lineTo(this.coords[t].x+this.shadow.x,this.coords[t].y+this.shadow.y);s.fillStyle=this.shadowColor,s.fill(),s.closePath(),s.filter="blur(0px)",super.draw()}};var a=30,x=12,m=class{constructor({pos:t,type:r,rotation:n}){this.pos=t,this.type=r,this.rotation=n,this.size=a,this.gradient=s.createRadialGradient(0,0,0,0,0,this.size),this.gradient.addColorStop(.4,"#202020"),this.gradient.addColorStop(1,"#000")}draw(){s.save(),s.shadowBlur=10,s.shadowColor="#000",s.translate(this.pos.x,this.pos.y),s.fillStyle=this.gradient,s.beginPath(),s.arc(0,0,this.size,0,2*Math.PI),s.fill(),s.closePath(),s.restore()}drawMounting(){s.save();let t=10;s.lineWidth=t,s.strokeStyle="rgb(230,180,0)",s.lineCap="round",s.shadowBlur=10,s.shadowColor="rgba(255,200,0,0.25)",s.translate(this.pos.x,this.pos.y),s.rotate(this.rotation*(Math.PI/180)),this.type=="corner"?(s.beginPath(),s.moveTo(-t/2-x,this.size+60-x),s.arc(0,0,this.size+t/2,(.5+.16)*Math.PI,(2-.16)*Math.PI),s.lineTo(this.size+60-x,-t/2-x),s.stroke(),s.closePath()):this.type=="edge"&&(s.beginPath(),s.moveTo(-this.size-50,-t/2),s.arc(0,0,this.size+t/2,(1+.04)*Math.PI,(2-.04)*Math.PI),s.lineTo(this.size+50,-t/2),s.stroke(),s.closePath()),s.restore()}includes(t){return E(this.pos,t.pos)<=this.size}};function Q(){return[new f({coords:[{x:e+a+10,y:e},{x:e+a+20+10,y:e+20},{x:o.width/2-a-20,y:e+20},{x:o.width/2-a,y:e}],shadow:{x:0,y:5}}),new f({coords:[{x:o.width/2-a,y:o.height-e},{x:o.width/2-a-20,y:o.height-(e+20)},{x:e+a+20+10,y:o.height-(e+20)},{x:e+a+10,y:o.height-e}],shadow:{x:0,y:-5}}),new f({coords:[{x:o.width/2+a,y:e},{x:o.width/2+a+20,y:e+20},{x:o.width-a-e-20-10,y:e+20},{x:o.width-a-e-10,y:e}],shadow:{x:0,y:5}}),new f({coords:[{x:o.width-a-e-10,y:o.height-e},{x:o.width-a-e-20-10,y:o.height-(e+20)},{x:o.width/2+a+20,y:o.height-(e+20)},{x:o.width/2+a,y:o.height-e}],shadow:{x:0,y:-5}}),new f({coords:[{x:e,y:o.height-e-a-10},{x:e+20,y:o.height-e-20-a-10},{x:e+20,y:e+a+20+10},{x:e,y:e+a+10}],shadow:{x:5,y:0}}),new f({coords:[{x:o.width-e,y:e+a+10},{x:o.width-(e+20),y:e+a+20+10},{x:o.width-(e+20),y:o.height-e-20-a-10},{x:o.width-e,y:o.height-e-a-10}],shadow:{x:-5,y:0}})]}function X(){return[new m({pos:{x:e+x,y:e+x},type:"corner",rotation:0}),new m({pos:{x:o.width/2,y:e},type:"edge",rotation:0}),new m({pos:{x:o.width-e-x,y:e+x},type:"corner",rotation:90}),new m({pos:{x:e+x,y:o.height-e-x},type:"corner",rotation:-90}),new m({pos:{x:o.width/2,y:o.height-e},type:"edge",rotation:180}),new m({pos:{x:o.width-e-x,y:o.height-e-x},type:"corner",rotation:180})]}var O=new k({balls:q(),pockets:X(),bumpers:Q()});O.drawTable();function j(){Y(),O.update(),O.draw(),requestAnimationFrame(j)}j();setTimeout(()=>{B("Use your mouse to control the white ball.<br>Try to pocket every other ball with it.<br>The black ball has to be the last one.")},500);})();
